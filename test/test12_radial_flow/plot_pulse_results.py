#!/usr/bin/env python3
"""
Plot pulse injection test results from CSV data generated by Julia simulation
"""

import numpy as np
import matplotlib.pyplot as plt
import os
import sys

def plot_pulse_injection_results(data_dir="."):
    """
    Plot the results from pulse injection test
    """

    csv_file_1 = os.path.join(data_dir, "test12_pulse_direct_results.csv")
    csv_file_2 = os.path.join(data_dir, "test12_pulse_spatial_profiles.csv")
    csv_file_3 = os.path.join(data_dir, "test12_pulse_statistics.csv")

    # Check if files exist
    if not os.path.exists(csv_file_1):
        print(f"Error: {csv_file_1} not found!")
        print("Please run: julia test12_pulse_direct.jl")
        return

    print("Loading data from CSV files...")

    # ==================== LOAD DATA ====================

    # Load chromatogram data (time vs outlet concentration)
    data1 = []
    with open(csv_file_1, 'r') as f:
        for line in f:
            if line.startswith('#') or line.startswith('time'):
                continue
            values = line.strip().split(',')
            if len(values) >= 3:
                data1.append([float(v) for v in values])

    data1 = np.array(data1)
    time = data1[:, 0]
    c_outlet = data1[:, 1]
    c_inlet = data1[:, 2]

    print(f"  Loaded {len(time)} time points")

    # Check for invalid data
    n_invalid = np.sum(~np.isfinite(c_outlet))
    if n_invalid > 0:
        print(f"  Warning: {n_invalid} invalid data points (NaN/Inf) in outlet concentration")

    # Load spatial profiles (optional - not generated in simplified version)
    if os.path.exists(csv_file_2):
        try:
            data2_lines = []
            with open(csv_file_2, 'r') as f:
                lines = f.readlines()
                header = lines[0].strip()
                for line in lines[1:]:
                    values = line.strip().split(',')
                    if len(values) > 1:  # Check if it's actually spatial data
                        data2_lines.append([float(v) for v in values])

            if len(data2_lines) > 0:
                data2 = np.array(data2_lines)
                rho = data2[:, 0]
                profiles = data2[:, 1:]
                print(f"  Loaded {profiles.shape[1]} spatial profiles")
            else:
                rho = None
                profiles = None
                print("  Note: Spatial profiles not available")
        except Exception as e:
            print(f"  Note: Could not load spatial profiles: {e}")
            rho = None
            profiles = None
    else:
        print("  Note: Spatial profiles file not found (requires direct ODE solver access)")
        rho = None
        profiles = None

    # Load statistics (simplified format: time, c_outlet)
    if os.path.exists(csv_file_3):
        data3 = []
        with open(csv_file_3, 'r') as f:
            for line in f:
                if line.startswith('time'):
                    continue
                values = line.strip().split(',')
                if len(values) >= 2:
                    data3.append([float(v) for v in values])

        if len(data3) > 0:
            data3 = np.array(data3)
            time_stats = data3[:, 0]
            c_outlet_stats = data3[:, 1]
            print(f"  Loaded statistics for {len(time_stats)} time points")
        else:
            time_stats = None
            c_outlet_stats = None
    else:
        time_stats = None
        c_outlet_stats = None

    # ==================== CREATE PLOTS ====================

    print("\nGenerating plots...")

    # Figure 1: Chromatogram (main result)
    fig1, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8), sharex=True)

    # Top: Inlet concentration
    ax1.plot(time, c_inlet, 'b-', linewidth=2, label='Inlet concentration')
    ax1.axvspan(1, 60, alpha=0.2, color='blue', label='Injection period')
    ax1.set_ylabel('Inlet Concentration', fontsize=12, fontweight='bold')
    ax1.set_title('Pulse Injection Test: Radial Flow Chromatography',
                  fontsize=14, fontweight='bold')
    ax1.grid(True, alpha=0.3)
    ax1.legend(loc='upper right')
    ax1.set_ylim(-0.1, 1.3)

    # Add phase labels
    ax1.text(0.5, 1.1, 'Baseline', ha='center', fontsize=9, color='gray')
    ax1.text(30, 1.15, 'PULSE INJECTION', ha='center', fontsize=11,
             fontweight='bold', color='blue')
    ax1.text(95, 1.1, 'Washout', ha='center', fontsize=9, color='gray')

    # Bottom: Outlet concentration (chromatogram)
    ax2.plot(time, c_outlet, 'r-', linewidth=2, label='Outlet concentration')
    ax2.axvspan(1, 60, alpha=0.2, color='blue', label='Injection period')
    ax2.set_xlabel('Time [s]', fontsize=12, fontweight='bold')
    ax2.set_ylabel('Outlet Concentration', fontsize=12, fontweight='bold')
    ax2.grid(True, alpha=0.3)
    ax2.legend(loc='upper right')

    # Set y-limits safely, handling NaN/Inf
    c_outlet_valid = c_outlet[np.isfinite(c_outlet)]
    if len(c_outlet_valid) > 0:
        y_max = max(c_outlet_valid) * 1.2
        ax2.set_ylim(-0.05, y_max)
    else:
        ax2.set_ylim(-0.05, 1.2)

    # Mark section transitions
    ax2.axvline(x=1, color='gray', linestyle='--', alpha=0.5, linewidth=1)
    ax2.axvline(x=60, color='gray', linestyle='--', alpha=0.5, linewidth=1)

    # Find and mark peak (only if valid data exists)
    if len(c_outlet_valid) > 0:
        idx_max = np.argmax(c_outlet)
        t_max = time[idx_max]
        c_max = c_outlet[idx_max]
    else:
        idx_max = 0
        t_max = 0
        c_max = 0
    ax2.plot(t_max, c_max, 'ro', markersize=8, label=f'Peak at t={t_max:.1f}s')
    ax2.annotate(f'Peak: {c_max:.4f}\nat t={t_max:.1f}s',
                xy=(t_max, c_max), xytext=(t_max+10, c_max*0.8),
                fontsize=9, fontweight='bold',
                bbox=dict(boxstyle='round,pad=0.5', facecolor='yellow', alpha=0.7),
                arrowprops=dict(arrowstyle='->', connectionstyle='arc3,rad=0.3'))

    # Add info box
    textstr = '\n'.join([
        'Test Configuration:',
        '• Pulse: t = 1-60 s (c = 1.0)',
        '• Washout: t > 60 s (c = 0)',
        '• Radial flow geometry',
        '• Dispersion included',
    ])
    props = dict(boxstyle='round', facecolor='wheat', alpha=0.8)
    ax2.text(0.02, 0.97, textstr, transform=ax2.transAxes, fontsize=9,
            verticalalignment='top', bbox=props)

    plt.tight_layout()
    output_file_1 = os.path.join(data_dir, "test12_pulse_chromatogram.png")
    plt.savefig(output_file_1, dpi=300, bbox_inches='tight')
    print(f"  Saved: {output_file_1}")

    # Figure 2: Spatial profiles (if available)
    if rho is not None and profiles is not None:
        fig2, ax = plt.subplots(figsize=(10, 6))

        n_profiles = profiles.shape[1]
        colors = plt.cm.viridis(np.linspace(0, 1, n_profiles))

        for i in range(n_profiles):
            # Parse time from header (approximate)
            t_label = f"t ≈ {i*25:.0f}s" if n_profiles > 4 else f"Profile {i+1}"
            ax.plot(rho * 100, profiles[:, i], '-', linewidth=2,
                   color=colors[i], label=t_label)

        ax.set_xlabel('Radial Position [cm]', fontsize=12, fontweight='bold')
        ax.set_ylabel('Concentration', fontsize=12, fontweight='bold')
        ax.set_title('Spatial Concentration Profiles at Different Times',
                    fontsize=14, fontweight='bold')
        ax.grid(True, alpha=0.3)
        ax.legend(loc='best')

        plt.tight_layout()
        output_file_2 = os.path.join(data_dir, "test12_pulse_spatial_profiles.png")
        plt.savefig(output_file_2, dpi=300, bbox_inches='tight')
        print(f"  Saved: {output_file_2}")

    # Figure 3: Statistics over time (simplified - just outlet concentration)
    # Note: Full spatial statistics require direct ODE solver access
    if time_stats is not None and c_outlet_stats is not None:
        print("  Note: Spatial statistics not available (simplified version)")
        # Skip statistics plot since we only have outlet data which is already plotted
    else:
        print("  Note: Statistics file not found or empty")

    print("\nAll plots generated successfully!")
    print("\nTo view plots, open the PNG files in the test directory.")

    # Show plots (optional - comment out if running headless)
    # plt.show()

if __name__ == "__main__":
    # Allow specifying data directory as command line argument
    if len(sys.argv) > 1:
        data_dir = sys.argv[1]
    else:
        data_dir = "."  # Current directory by default

    plot_pulse_injection_results(data_dir)
